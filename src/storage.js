/**
 * –ú–û–î–£–õ–¨: –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• (storage.js)
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:
 * - –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
 * - –ö–ª—é—á —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: tasks_${userId}
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */

// üéØ –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –í –ü–ê–ú–Ø–¢–ò
let tasks = []

/**
 * –ü–û–õ–£–ß–ï–ù–ò–ï –ö–õ–Æ–ß–ê –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø –ó–ê–î–ê–ß –¢–ï–ö–£–©–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * - –ü–∞—Ä—Å–∏—Ç JWT —Ç–æ–∫–µ–Ω —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å userId
 * - –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
 */
const getTasksKey = () => {
    const token = localStorage.getItem('token')
    if (!token) return null
    
    try {
        const parts = token.split('.')
        const payload = JSON.parse(atob(parts[1]))
        return `tasks_${payload.userId}`  // üéØ –£–ù–ò–ö–ê–õ–¨–ù–´–ô –ö–õ–Æ–ß –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    } catch {
        return null
    }
}

/**
 * –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó LOCALSTORAGE –ü–†–ò –ó–ê–ü–£–°–ö–ï
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
 * - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª—é—á –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ–≥–æ –∑–∞–¥–∞—á–∏
 * - –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
 */
const loadFromStorage = () => {
    try {
        const tasksKey = getTasksKey()
        if (!tasksKey) {
            tasks = [] // üîê –ù–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø - –ù–ï–¢ –ó–ê–î–ê–ß
            return
        }
        
        const saved = localStorage.getItem(tasksKey)
        if (saved) {
            tasks = JSON.parse(saved)
        } else {
            tasks = [] // üìù –ü–ï–†–í–´–ô –í–•–û–î - –ü–£–°–¢–û–ô –°–ü–ò–°–û–ö
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', error)
        tasks = []
    }
}

// üöÄ –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
loadFromStorage()

/**
 * –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –í LOCALSTORAGE
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
 * - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫–ª—é—á —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
 * - –ù–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å localStorage
 */
const saveToStorage = () => {
    try {
        const tasksKey = getTasksKey()
        if (tasksKey) {
            localStorage.setItem(tasksKey, JSON.stringify(tasks))
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error)
    }
}

/**
 * –°–ë–†–û–° –ó–ê–î–ê–ß –í –ü–ê–ú–Ø–¢–ò –ü–†–ò –°–ú–ï–ù–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
 * 
 * –ö–û–ì–î–ê –í–´–ó–´–í–ê–¢–¨:
 * - –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ü–æ—Å–ª–µ –ª–æ–≥–∞—É—Ç–∞
 * - –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è authExpired
 * 
 * –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù: –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–º–µ—à–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
export const resetTaskStorage = () => {
    tasks = []
    loadFromStorage() // üîÑ –ó–ê–ì–†–£–ó–ò–¢ –ó–ê–î–ê–ß–ò –ù–û–í–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
}

/**
 * –ü–û–õ–£–ß–ï–ù–ò–ï –í–°–ï–• –ó–ê–î–ê–ß (READ-ONLY)
 * 
 * –í–û–ó–í–†–ê–©–ê–ï–¢: –ö–æ–ø–∏—é –º–∞—Å—Å–∏–≤–∞ –∑–∞–¥–∞—á —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * –ó–ê–ß–ï–ú –ö–û–ü–ò–Ø: –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
 */
export const getTasksFromStorage = () => {
    return [...tasks] // üõ°Ô∏è –ó–ê–©–ò–¢–ù–ê–Ø –ö–û–ü–ò–Ø
}

/**
 * –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ô –ó–ê–î–ê–ß–ò
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏ userId - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
 */
export const addTaskToStorage = (taskData) => {
    const newTask = typeof taskData === 'string' 
        ? {
            id: Date.now().toString(),
            text: taskData.trim(),
            completed: false,
            createdAt: new Date().toISOString(),
            source: 'user'
        }
        : {
            ...taskData,
            id: taskData.id || Date.now().toString(),
            createdAt: taskData.createdAt || new Date().toISOString(),
            source: taskData.source || 'api'
        }
    
    tasks = [...tasks, newTask]
    saveToStorage()
    return newTask
}

/**
 * –£–î–ê–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò –ü–û ID
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
 * - –£–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –∑–∞–¥–∞—á —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ù–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
export const removeTaskFromStorage = (id) => {
    tasks = tasks.filter(task => task.id !== id)
    saveToStorage()
}

/**
 * –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ó–ê–î–ê–ß–ò
 * 
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
 * - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –∑–∞–¥–∞—á–∞–º–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * - –ò–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */
export const toggleTaskStatus = (id) => {
    tasks = tasks.map(task => {
        if (task.id === id) {
            return {
                ...task,
                completed: !task.completed
            }
        }
        return task
    })
    saveToStorage()
}

export const updateTaskText = (id, newText) => {
    const trimmedText = newText.trim()
    if (!trimmedText) return // üõ°Ô∏è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    
    tasks = tasks.map(task => 
        task.id === id 
            ? { ...task, text: trimmedText }
            : task
    )
    saveToStorage()
}

// üí° –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô:
// –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á
// –ü—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è resetTaskStorage() –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

// üîÆ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ù–û–í–û–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´:
// - ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
// - ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –∑–∞–¥–∞—á–∏ –Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è
// - ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// - ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–æ–º