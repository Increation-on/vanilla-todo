/**
 * üõ°Ô∏è –ú–ï–ù–ï–î–ñ–ï–† –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏
 * 
 * –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
 * - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 * - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–≤—Ö–æ–¥) —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ (–ª–æ–≥–∏–Ω/–ª–æ–≥–∞—É—Ç)
 * - –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ localStorage
 * 
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: 
 * - Stateless (–Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏)
 * - –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ localStorage
 * - –ß–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫—Ä–æ–º–µ side effects –≤ localStorage)
 */
import { createMockJWT, parseMockJWT } from '../utils/jwt.js'
import { generateUserId } from '../utils/id-generator.js'

export const AuthManager = {
    /**
     * üìã –ü–û–õ–£–ß–ï–ù–ò–ï –°–ü–ò–°–ö–ê –í–°–ï–• –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
     * 
     * –ü–†–ò–ù–¶–ò–ü: –í—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
     * –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
     */
    getUsers() {
        return JSON.parse(localStorage.getItem('users')) || []
    },

    /**
     * üìß –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –¢–ï–ö–£–©–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
     * 
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨:
     * - –ü–æ–ª—É—á–∞–µ–º email –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞ –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
     * - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ö–µ–¥–µ—Ä–µ
     */
    getCurrentUser() {
        if (!this.isLoggedIn()) return null

        const token = localStorage.getItem('token')
        const payload = parseMockJWT(token)
        return {
            email: payload.email,
            expires: payload.expires
        }
    },

    /**
     * üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
     * –ü–†–û–¶–ï–°–°:
     * 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ email –µ—â–µ –Ω–µ –∑–∞–Ω—è—Ç
     * 2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
     * 4. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –í–•–û–î–ò–ú –í –°–ò–°–¢–ï–ú–£
     */
    register(email, password) {
        const users = this.getUsers()
        const existingUser = users.find(user => user.email === email)
        if (existingUser) {
            return false
        }

        const newUser = {id: generateUserId(), email, password }
        users.push(newUser)
        localStorage.setItem('users', JSON.stringify(users))

        // üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –í–•–û–î –ü–û–°–õ–ï –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
        return this.login(email, password)
    },

    /**
     * üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–í–•–û–î –í –°–ò–°–¢–ï–ú–£)
     * 
     * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
     * - –í–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç—ã—Ö —Ñ–ª–∞–≥–æ–≤ —Å–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω
     * - –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç email –∏ –≤—Ä–µ–º—è expiration
     * - –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ 12 –º–∏–Ω—É—Ç (720000 –º—Å)
     */
    login(email, password) {
        const users = this.getUsers()
        const user = users.find(user =>
            user.email === email && user.password === password
        )

        if (!user) {
            return false
        }

        // üé´ –°–û–ó–î–ê–ï–ú JWT –¢–û–ö–ï–ù
        const token = createMockJWT({
            userId: user.id,
            email: user.email,
            expires: Date.now() + 7200000 // 120 –º–∏–Ω—É—Ç
        })

        localStorage.setItem('token', token)

        return true
    },

    /**
     * üö™ –í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´ (–ó–ê–í–ï–†–®–ï–ù–ò–ï –°–ï–°–°–ò–ò)
     * 
     * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
     * - –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ JWT —Ç–æ–∫–µ–Ω
     * - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –±—É–¥—É—â–∏—Ö –≤—Ö–æ–¥–æ–≤
     */
    logout() {
        localStorage.removeItem('token')
    },

    /**
     * üîç –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
     * 
     * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
     * - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
     * - –ü–∞—Ä—Å–∏–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
     * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º –ø—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ
     */
    isLoggedIn() {
        const token = localStorage.getItem('token')
        if (!token) return false

        const payload = parseMockJWT(token)
        if (!payload) return false

        // üïí –ü–†–û–í–ï–†–ö–ê –ü–†–û–°–†–û–ß–ö–ò –¢–û–ö–ï–ù–ê
        if (Date.now() > payload.expires) {
            this.logout()
            return false
        }

        return true
    },

    /**
     * ‚è∞ –ó–ê–ü–£–°–ö –°–õ–ï–ñ–ï–ù–ò–Ø –ó–ê –¢–û–ö–ï–ù–û–ú
     * 
     * –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨:
     * - –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
     * - –ü—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
     * - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
     */
    startTokenWatch() {
        setInterval(() => {
            if (!this.isLoggedIn()) {
                this.logout()
                window.dispatchEvent(new CustomEvent('authExpired'))
            }
        }, 60000)
    }
}

// üí° –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
// - –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨: —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏
// - –ù–ò–ó–ö–ê–Ø –°–í–Ø–ó–ê–ù–ù–û–°–¢–¨: –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç UI, —Ç–æ–ª—å–∫–æ –æ—Ç –¥–∞–Ω–Ω—ã—Ö
// - –í–°–ï–ì–î–ê –ê–ö–¢–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï: –∫–∞–∂–¥—ã–π —Ä–∞–∑ —á–∏—Ç–∞–µ–º –∏–∑ localStorage

// üîÆ –í–û–ó–ú–û–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:
// - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (bcrypt)
// - JWT —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ —Ñ–ª–∞–≥–æ–≤ –≤ localStorage
// - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏
// - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è