/**
 * –ú–û–î–£–õ–¨: –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (router.js)
 * 
 * –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∑–∞–¥–∞—á –ø–æ URL
 * 
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: Client-Side Routing (SPA)
 * - –ò—Å—Ç–æ—Ä–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 * - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—É—Ç–∏
 * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–∫–ª–∏–∫–∏ + –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
 * 
 * –ü–†–ò–ù–¶–ò–ü: URL –∫–∞–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
 */

import { getTasksFromStorage } from "./storage.js";
import { renderTask, createTaskElement } from "./dom-manager.js";
import { taskList } from "./dom-elements.js";
import { bindTaskEventHandlers as bindTaskEvents } from "./task-event-binder.js";

/**
 * –ü–û–ö–ê–ó–´–í–ê–ï–¢ –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ù–´–ï –ó–ê–î–ê–ß–ò –ü–û –¢–ò–ü–£
 * 
 * –§–ò–õ–¨–¢–†–´:
 * - 'all'       ‚Üí –≤—Å–µ –∑–∞–¥–∞—á–∏
 * - 'active'    ‚Üí —Ç–æ–ª—å–∫–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (!completed)
 * - 'completed' ‚Üí —Ç–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (completed)
 * 
 * –ü–†–û–¶–ï–°–°:
 * 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
 * 2. –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É
 * 3. –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ (–ø—Ä–æ—â–µ —á–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
 * 
 * –ü–û–ß–ï–ú–£ –ü–ï–†–ï–†–ò–°–û–í–ö–ê: –ù–∞–¥–µ–∂–Ω–µ–µ —á–µ–º –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
 * –í—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –¥–∞–Ω–Ω—ã–º–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
 */
export const showFilteredTasks = (filterType) => {
    const tasks = getTasksFromStorage();

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    const filtered = tasks.filter(task => {
        if (filterType === 'active') return !task.completed;
        if (filterType === 'completed') return task.completed;
        return true; // 'all' - –≤—Å–µ –∑–∞–¥–∞—á–∏
    });

    // –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
    taskList.innerHTML = '';
    filtered.forEach(task => {
        const { taskContainer, taskText, checkbox, deleteButton, editButton, id } = createTaskElement(task)
        renderTask(taskContainer);
        bindTaskEvents(taskContainer, taskText, checkbox, deleteButton, editButton, id);
    });
}

/**
 * –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ï –ú–ê–†–®–†–£–¢–ê
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * - –°–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π URL (window.location.pathname)
 * - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–æ–π —Ñ–∏–ª—å—Ç—Ä –ø–æ–∫–∞–∑–∞—Ç—å
 * - –í—ã–∑—ã–≤–∞–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–¥–∞—á
 * 
 * –û–°–û–ë–´–ï –°–õ–£–ß–ê–ò:
 * - –ü—É—Å—Ç–æ–π –ø—É—Ç—å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
 * - –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
 */
const handleRouteChange = () => {
    const path = window.location.pathname;

    switch (path) {
        case '/':                    // –ì–ª–∞–≤–Ω–∞—è - –≤—Å–µ –∑–∞–¥–∞—á–∏
            showFilteredTasks('all')
            break
        case '/active':              // –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
            showFilteredTasks('active')
            break
        case '/completed':           // –¢–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
            showFilteredTasks('completed')
            break
        case '':                     // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç–æ–≥–æ URL
            showFilteredTasks('all')
            break
        default:                     // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
            history.replaceState(null, '', '/') // –¢–∏—Ö–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
            showFilteredTasks('all')
            break
    }
}

/**
 * –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò
 * 
 * –ù–ê–°–¢–†–ê–ò–í–ê–ï–¢:
 * - –û–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–æ–ø–æ–∫ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥ (popstate)
 * - –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–ª–∏–∫–æ–≤ –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–º —Å—Å—ã–ª–∫–∞–º
 * - –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø–æ —Ç–µ–∫—É—â–µ–º—É URL
 * 
 * –ö–õ–Æ–ß–ï–í–û–ô –ü–ê–¢–¢–ï–†–ù: Event-driven routing
 * –†–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Å–æ–±—ã—Ç–∏—è, –∞ –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
 */
export const initRouter = () => {
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ (–Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
    window.addEventListener('popstate', () => {
        handleRouteChange()
    });

    // –ö–ª–∏–∫–∏ –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–º —Å—Å—ã–ª–∫–∞–º
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('nav-link')) {
            e.preventDefault() // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            const newPath = e.target.getAttribute('href');
            history.pushState(null, '', newPath); // –ú–µ–Ω—è–µ–º URL
            handleRouteChange() // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        }
    })

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ —Ç–µ–∫—É—â–µ–º—É URL
    handleRouteChange()
}

// üí° –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô:
// –†–æ—É—Ç–µ—Ä –∑–Ω–∞–µ—Ç –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ –Ω–µ –æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –∑–∞–¥–∞—á.
// –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ - –æ–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç –ö–ê–ö –ø–æ–∫–∞–∑–∞—Ç—å, –∞ –Ω–µ –ß–¢–û –ø–æ–∫–∞–∑–∞—Ç—å.

// üîÆ –í–û–ó–ú–û–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:
// - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã (/task/:id)
// - Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–ª–æ–∂–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
// - –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏