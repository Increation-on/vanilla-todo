// api.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô
import { getTasksFromStorage } from './storage.js'          // üì¶ –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á –∏–∑ localStorage
import { addTaskFromSource } from './task-controller.js' // üéØ –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞
import { showToast } from './toast.js';          // üîî –ò–º–ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

// üöÄ –≠–ö–°–ü–û–†–¢ –≥–ª–∞–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–¥—É–ª—è - –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ API
export const loadTaskFromAPI = async () => {
    // üìã –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –î–û –∑–∞–ø—Ä–æ—Å–∞ –∫ API (—á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Å—Ç–∞–ª–∏ –ø–æ–∫–∞ –∏–¥–µ—Ç –∑–∞–ø—Ä–æ—Å)
    const currentTasks = getTasksFromStorage();

    // üõ°Ô∏è –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤–µ—Å—å —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ try/catch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
    try {
        // üåê –î–µ–ª–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É API —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤ 3 –∑–∞–¥–∞—á–∏
        const response = await fetch('https://jsonplaceholder.typicode.com/todos?_limit=3')

        // ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –£–°–ü–ï–®–ù–û–°–¢–¨ HTTP-–∑–∞–ø—Ä–æ—Å–∞ (—Å—Ç–∞—Ç—É—Å—ã 200-299)
        if (!response.ok) {
            // ‚ùå –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (404, 500 –∏ —Ç.–¥.) - –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            throw new Error(`HTTP error! status: ${response.status}`)
        }

        // üì¶ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
        let data
        try {
            // üéØ –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ JSON –≤ JavaScript-–æ–±—ä–µ–∫—Ç
            data = await response.json()
        } catch (parseError) {
            // ‚ùå –ï—Å–ª–∏ JSON –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π (—Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON) - –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
            throw new Error('Invalid JSON response from server')
        }

        // üéØ –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–•
        // üîç –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ API –≤–µ—Ä–Ω—É–ª –∏–º–µ–Ω–Ω–æ –º–∞—Å—Å–∏–≤ (–∞ –Ω–µ –æ–±—ä–µ–∫—Ç –∏–ª–∏ —Å—Ç—Ä–æ–∫—É)
        if (!Array.isArray(data)) {
            throw new Error('API returned non-array data')
        }

        // üéØ –ü–†–û–í–ï–†–ö–ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ü–û–õ–ï–ô
        // üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º –ö–ê–ñ–î–£–Æ –∑–∞–¥–∞—á—É –≤ –º–∞—Å—Å–∏–≤–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        data.forEach((item, index) => {
            // ‚ùó title –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –Ω–µ –±—ã—Ç—å –ø—É—Å—Ç—ã–º, completed –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (–¥–∞–∂–µ –µ—Å–ª–∏ false)
            if (!item.title || item.completed === undefined) {
                throw new Error(`Invalid task format at index ${index}`)
            }
        })

        // üé™ –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –ò –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•
        const filteredTasks = data
            // üîÑ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞–∂–¥—É—é –∑–∞–¥–∞–∫—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ API –≤ –Ω–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
            .map(({ title, completed, id }) => ({
                id: `api-${id}`,        // üè∑Ô∏è  –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å API-–∑–∞–¥–∞—á–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö
                text: title,            // üìù  –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–æ–ª–µ title ‚Üí text –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                completed: completed    // ‚úÖ  –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            }))
            // üö´ –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ
            .filter(apiTask => {
                return !currentTasks.some(existingTask =>
                    existingTask.id === apiTask.id ||        // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ID (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥—É–±–ª–∏–∫–∞—Ç)
                    existingTask.text === apiTask.text       // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–∫—Å—Ç—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥—É–±–ª–∏–∫–∞—Ç)
                )
            })

        // üéä –§–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê - –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        if (filteredTasks.length > 0) {
            // ‚ûï –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            filteredTasks.forEach(task => {
                addTaskFromSource('api', task);  // üìç –£–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ 'api' –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            })
            // üîî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
            showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${filteredTasks.length} –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á`, 'success')
        } else {
            // ‚ÑπÔ∏è –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç - –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            showToast('–ù–æ–≤—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç', 'info')
        }

    } catch (error) {
        // üö® –û–ë–†–ê–ë–û–¢–ö–ê –õ–Æ–ë–û–ô –û–®–ò–ë–ö–ò, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤ –±–ª–æ–∫–µ try
        console.error('–û—à–∏–±–∫–∞:', error)  // üìù –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
        // üîî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        showToast(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏: ${error.message}`, 'error')
    }
}