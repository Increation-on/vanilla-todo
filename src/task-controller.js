/**
 * –ú–û–î–£–õ–¨: –ö–û–ù–¢–†–û–õ–õ–ï–† –ó–ê–î–ê–ß (task-controller.js)
 * 
 * –ó–ê–ß–ï–ú –ù–£–ñ–ï–ù: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
 * 
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: Business Logic Layer
 * - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
 * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–¥—É–±–ª–∏–∫–∞—Ç—ã)
 * - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É storage –∏ DOM
 * 
 * –ü–†–ò–ù–¶–ò–ü: –ü–æ—Å—Ä–µ–¥–Ω–∏–∫ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ —Å–∏—Å—Ç–µ–º–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
 */

import { addTaskToStorage, getTasksFromStorage } from './storage.js'
import { renderTask, createTaskElement } from './dom-manager.js'
import { taskInput } from './dom-elements.js'
import { bindTaskEventHandlers as bindTaskEvents } from './task-event-binder.js'
import { showFilteredTasks } from './router.js'

/**
 * –ü–†–û–í–ï–†–ö–ê –í–ê–õ–ò–î–ù–û–°–¢–ò –¢–ï–ö–°–¢–ê –ó–ê–î–ê–ß–ò
 * 
 * –ü–†–ê–í–ò–õ–ê –í–ê–õ–ò–î–ê–¶–ò–ò:
 * - –ù–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
 * - –ù–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
 * 
 * –í–û–ó–í–†–ê–©–ê–ï–¢: true –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
 */
const validateTask = (text) => text.trim() !== ''

/**
 * –ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í –ó–ê–î–ê–ß
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –µ–¥–∏–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã)
 * - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
 * - –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
 * 
 * –ó–ê–ß–ï–ú: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–¥–∞—á
 */
const hasDuplicate = (newTaskText) => {
    const savedTasks = getTasksFromStorage()
    const normalizedNew = newTaskText.toLowerCase().replace(/\s+/g, ' ').trim();

    return savedTasks.some(task => {
        const normalizedSaved = task.text.toLowerCase().replace(/\s+/g, ' ').trim();
        return normalizedSaved === normalizedNew
    })
}

/**
 * –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß –ò–ó –õ–Æ–ë–û–ì–û –ò–°–¢–û–ß–ù–ò–ö–ê
 * 
 * –ò–°–¢–û–ß–ù–ò–ö–ò:
 * - 'user'   ‚Üí –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
 * - 'storage' ‚Üí –∏–∑ localStorage (–ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç)
 * - 'api'    ‚Üí —Å —Å–µ—Ä–≤–µ—Ä–∞ (–æ–±—ä–µ–∫—Ç —Å API-—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)
 * 
 * –ü–†–û–¶–ï–°–° –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ò–°–¢–û–ß–ù–ò–ö–ê:
 * 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
 * 2. –°–æ–∑–¥–∞–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
 * 3. –†–µ–Ω–¥–µ—Ä–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
 * 4. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
 */
export const addTaskFromSource = (source, data) => {
    switch (source) {
        case 'user': {
            // üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª —Ç–µ–∫—Å—Ç –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            const userData = data.text
            const newTask = addTaskToStorage(userData)
            const { taskContainer, taskText, checkbox, deleteButton, id } = createTaskElement(newTask)
            renderTask(taskContainer)
            bindTaskEvents(taskContainer, taskText, checkbox, deleteButton, id)
            break
        }

        case 'storage': {
            // üéØ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage (–ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
            const storageData = data
            const { taskContainer, taskText, checkbox, deleteButton, id } = createTaskElement(storageData)
            renderTask(taskContainer)
            bindTaskEvents(taskContainer, taskText, checkbox, deleteButton, id)
            break
        }

        case 'api': {
            // üéØ –ó–∞–≥—Ä—É–∑–∫–∞ —Å –≤–Ω–µ—à–Ω–µ–≥–æ API
            const apiTask = addTaskToStorage({
                id: data.id,
                text: data.text,
                completed: data.completed
            })
            const { taskContainer, taskText, checkbox, deleteButton, id } = createTaskElement(apiTask)
            renderTask(taskContainer)
            bindTaskEvents(taskContainer, taskText, checkbox, deleteButton, id)
            break
        }
    }
}

/**
 * –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–û–ô –ó–ê–î–ê–ß–ò –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
 * 
 * –ü–û–õ–ù–´–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò:
 * 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ (–Ω–µ –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç)
 * 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
 * 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ storage
 * 4. –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ DOM
 * 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é (–µ—Å–ª–∏ –±—ã–ª –¥—Ä—É–≥–æ–π —Ñ–∏–ª—å—Ç—Ä)
 * 
 * UX-–£–õ–£–ß–®–ï–ù–ò–ï: –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
 * (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é –µ—Å–ª–∏ –±—ã–ª–∏ –≤ —Ñ–∏–ª—å—Ç—Ä–µ completed/active)
 */
export const handleNewTask = () => {
    const text = taskInput.value
    
    // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –º—É—Å–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (!validateTask(text)) return

    // ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö
    if (hasDuplicate(text)) {
        const shouldAddAnyway = confirm(`–ó–∞–¥–∞—á–∞ "${text}" –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ä–∞–∑?`)
        if (!shouldAddAnyway) return
    }
    
    // üßπ –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
    taskInput.value = ''
    
    // üéØ –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    addTaskFromSource('user', { text })
    
    // üîÑ UX: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π
    const currentPath = window.location.pathname
    if (currentPath !== '/') {
        history.pushState(null, '', '/')
        showFilteredTasks('all')
    }
}

/**
 * –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–î–ê–ß –ü–†–ò –ó–ê–ü–£–°–ö–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
 * 
 * –ó–ê–ß–ï–ú: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑ localStorage
 * –ö–û–ì–î–ê –í–´–ó–´–í–ê–ï–¢–°–Ø: –û–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * 
 * –ü–†–û–¶–ï–°–°: –î–ª—è –∫–∞–∂–¥–æ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏ –≤—ã–∑—ã–≤–∞–µ–º addTaskFromSource
 * —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º 'storage' (—É–∂–µ –≥–æ—Ç–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã –∑–∞–¥–∞—á)
 */
export const initializeTasks = () => {
    const savedTasks = getTasksFromStorage()

    savedTasks.forEach((task) => {
        addTaskFromSource('storage', task)
    })

    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
}

// üí° –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô:
// –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∑–Ω–∞–µ—Ç –û –í–°–ï–ú, –Ω–æ –Ω–µ –¥–µ–ª–∞–µ—Ç –Ω–∏—á–µ–≥–æ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
// –ï–≥–æ —Ä–æ–ª—å - –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

// üîÆ –í–û–ó–ú–û–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:
// - –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞, –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞)
// - Undo/redo –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞–¥–∞—á–∞–º–∏
// - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á –∏ —Å–ª–æ–∂–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã